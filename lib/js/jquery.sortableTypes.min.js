(function(a){a._sortableTypes={};a._sortableTypes.helper={element:null,mainSelect:null,typeList:null,input:null,defaults:{types:[],inputName:"types",texts:{title:"Create Type",parentType:"Parent Type",typeKey:"Type Key",typeNameDe:"Type Name De",typeNameEn:"Type Name En",createType:"Create Type"},templates:{basic:a('<div class="selectors"><div class="typeSelectors"><div class="mainTypeSelector"></div><div class="subTypeSelectors"></div></div><a id="createType" href="#"><img src="images/black_plus.png" width="10" height="10" /></a></div><div class="typeList"><ul class="listNoStyle"></ul></div>'),listElement:a('<li><span></span><a class="removeItem" href="#">X</a></li>')}},settings:{},init:function(c,b){this.element=c;this.settings=a.extend(this.defaults,b);this.element.append(this.settings.templates.basic);this.typeList=this.element.children(".typeList");this.input=a('<input type="hidden" />');this.input.attr("name",this.settings.inputName);this.element.append(this.input);a._sortableTypes.helper._addSelects();a._sortableTypes.helper._addCreateTypeDialog();a("#createType").click(this._createTypeClick)},updateInput:function(){var c=a._sortableTypes.helper,b="";c.typeList.children("ul").children().each(function(d,e){b+=a(e).data("typeId")+"-"});c.input.val(b.substr(0,b.length-1))},_addSelects:function(){var k=this,e=this.element.children(".selectors").children(".typeSelectors").children(".subTypeSelectors");this.mainSelect=a('<select><option value="0" disabled="true"></option></select>');for(var b=0;b<this.settings.types.length;b++){var f=this.settings.types[b],c=a("<option></option>");c.attr("value",f.main.id);c.text(f.main.name);c.data("key",f.main.key);if(f.sub){var g=a('<select><option value="0" disabled="true"></option></select>');g.attr("id",f.main.key);g.hide();for(var h=0;h<f.sub.length;h++){var d=a("<option></option>"),j=f.sub[h];d.attr("value",j.id);d.text(j.name);g.append(d)}g.change(function(){k._addListElement(a(this))});e.append(g)}this.mainSelect.append(c)}this.mainSelect.change(function(){a(this).hide();a(this).parent().next().children().hide();a("#"+a(this).children(":selected").data("key")).show();var i=a._sortableTypes.helper._addListElement(a(this));i.data("isMain",true)});this.element.children(".selectors").children(".typeSelectors").children(".mainTypeSelector").append(this.mainSelect)},_addCreateTypeDialog:function(){var c=a('<div id="createTypeDialog" style="display: none;"></div>'),b,e,d;c.append('<form method="post" action="index.php?page=AddCard"></form>');c.children().append("<table><tbody></tbody></table>");b=c.children().children("table").children("tbody");e=a("<tr></tr>");e.append("<td>"+this.settings.texts.parentType+"</td>");d=this.mainSelect.clone();d.children(":first").prop("disabled",false);d.children(":first").prop("selected",true);d.attr("id","parentSelect");d.attr("name","parent");e.append(d.wrap("<td></td>"));b.append(e);e=a("<tr></tr>");e.append("<td>"+this.settings.texts.typeKey+"</td>");e.append('<td><input type="text" name="typeKey" /></td>');b.append(e);e=a("<tr></tr>");e.append("<td>"+this.settings.texts.typeNameDe+"</td>");e.append('<td><input type="text" name="typeNameDe" /></td>');b.append(e);e=a("<tr></tr>");e.append("<td>"+this.settings.texts.typeNameEn+"</td>");e.append('<td><input type="text" name="typeNameEn" /></td>');b.append(e);e=a("<tr></tr>");e.append('<td colspan="2"><input type="submit" value="'+this.settings.texts.createType+'" /></td>');b.append(e);a("body").append(c)},_addListElement:function(b){var c=a._sortableTypes.helper.settings.templates.listElement.clone(),d=null;a._sortableTypes.helper.typeList.children("ul").children().each(function(e,g){var h=parseInt(a(g).data("typeId")),f=parseInt(b.val());if(h===f){d=a(g)}});if(d!==null){return d}c.children("span").text(b.children(":selected").text());c.data("typeId",b.val());c.children(".removeItem").click(function(){if(a(this).parent().data("isMain")){a(this).parent().parent().children().remove();b.parent().next().children().hide();b.parent().next().children().children(":first").prop("selected",true);b.show();b.children(":first").prop("selected",true)}else{a(this).parent().remove()}a._sortableTypes.helper.updateInput()});a._sortableTypes.helper.typeList.children("ul").append(c);a._sortableTypes.helper.updateInput();return c},_isNumber:function(b){return !isNaN(parseFloat(b))&&isFinite(b)},_createTypeClick:function(b){b.preventDefault();a("#createTypeDialog").dialog({title:a._sortableTypes.helper.settings.texts.title,modal:true,width:400,create:function(){var c=a(this);c.children("form").submit(function(g){g.preventDefault();var f={},h=a(this).serializeArray();for(var d=0;d<h.length;d++){if(a._sortableTypes.helper._isNumber(h[d].value)){f[h[d].name]=parseInt(h[d].value)}else{f[h[d].name]=h[d].value}}a.getJSON("ajax/createType.php",f,function(e){if(e.typeId){var k;if(typeof e.key!=="undefined"){k.main={id:e.typeId,key:e.key};if(e.language===1){k.main.name=f.typeNameDe}else{k.main.name=f.typeNameEn}a._sortableTypes.helper.settings.types.push(k)}else{var k,j,l;for(j=0;j<a._sortableTypes.helper.settings.types.length;j++){k=a._sortableTypes.helper.settings.types[j];if(parseInt(k.main.id)!==f.parent){continue}l={id:e.typeId,key:e.key};if(e.language===1){l.name=f.typeNameDe}else{l.name=f.typeNameEn}if(typeof k.sub==="undefined"){k.sub=[]}k.sub.push(l)}}a._sortableTypes.helper._redrawSelects();c.dialog("close")}})})},close:function(){a(this).dialog("destroy");a(this).find("input select").val("")}})},_redrawSelects:function(){console.log("redraw start");var e=this.element.children(".selectors").children(".typeSelectors"),d=false,b="",c="";if(e.children(".mainTypeSelector").children().is(":visible")===false){d=true;b=e.children(".mainTypeSelector").children().val();c=e.children(".mainTypeSelector").children().children(":selected").data("key")}e.children(".mainTypeSelector").children().remove();e.children(".subTypeSelectors").children().remove();this._addSelects();if(d){e.children(".mainTypeSelector").children().hide();e.children(".mainTypeSelector").children().val(b)}console.log("redraw end")}};a.fn.sortableTypes=function(b){a._sortableTypes.helper.init(a(this),b);a._sortableTypes.helper.typeList.children().sortable({containment:"parent",update:a._sortableTypes.helper.updateInput})}})(jQuery);